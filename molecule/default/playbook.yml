---
- name: Converge
  hosts: all
  gather_facts: false

  vars:
    ansible_python_interpreter: "{{ ansible_playbook_python }}"

  tasks:
    - include_tasks: generate-suffix.yml

    - name: Assure the temporary bucket exists
      s3_bucket:
        name: "temp-bucket-{{ temp_suffix }}"
        state: present

    - include_role:
        name: lambda-dependency-layer
      vars:
        name: "temp-layer-{{ temp_suffix }}"
        state: present
        context: ./tests/sample-data/ruby2.5
        runtime: ruby2.5
        bucket: "temp-bucket-{{ temp_suffix }}"
        object_key: layer.zip

    - name: Save the exported variables
      copy:
        content: "{{ hostvars[inventory_hostname] | to_json }}"
        dest: "{{ molecule_ephemeral_directory }}/role-variables-main.json"
      changed_when: false
